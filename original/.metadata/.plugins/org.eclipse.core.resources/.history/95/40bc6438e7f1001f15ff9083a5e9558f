package com.example.origin.controller;

import java.util.List;
import java.util.Optional;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.domain.Sort.Direction;
import org.springframework.data.web.PageableDefault;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.example.origin.entity.Category;
import com.example.origin.entity.Collection;
import com.example.origin.entity.Datas;
import com.example.origin.form.DatasEditForm;
import com.example.origin.form.DatasForm;
import com.example.origin.repository.CategoryRepository;
import com.example.origin.repository.CollectionRepository;
import com.example.origin.repository.DatasRepository;
import com.example.origin.repository.GenreRepository;
import com.example.origin.service.DatasService;
import com.example.origin.service.GenreService;

import jakarta.validation.Valid;

@Controller
@RequestMapping("/data")
public class DataController {
	private final DatasRepository datasRepository;
	private final CollectionRepository collectionRepository;
	private final GenreRepository genreRepository;
	private final CategoryRepository categoryRepository;
	private final DatasService datasService;
	private final GenreService genreService;
	
	public DataController(DatasRepository datasRepository
						,CollectionRepository collectionRepository
						,GenreRepository genreRepository
						,DatasService datasService
						,GenreService genreService
						,CategoryRepository categoryRepository) {
		this.datasRepository = datasRepository;
		this.collectionRepository = collectionRepository;
		this.genreRepository = genreRepository;
		this.datasService = datasService;
		this.genreService = genreService;
		this.categoryRepository = categoryRepository;
	}
	  @GetMapping("/{id}")
	    public String index(@PathVariable(name = "id") Integer id,Model model
	    					, @RequestParam(required = false) Integer categoryId
	    					, @PageableDefault(page = 0, size = 10, sort = "id", direction = Direction.ASC)Pageable pageable
	    					,@RequestParam(name = "keyword", required = false) String keyword
	    					,@RequestParam(name = "order", required = false, defaultValue = "createdAtDesc") String order
	    			        ) {
		  System.out.println("ãƒ†ã‚¹ãƒˆ");
		
		  Sort sort;
	        switch (order) {
	            case "wordAsc":
	                sort = Sort.by(Sort.Order.asc("name"));  // äº”åéŸ³é †ï¼ˆåå‰é †ï¼‰
	                break;
	            case "updatedAtAsc":
	                sort = Sort.by(Sort.Order.desc("updatedAt"));  // æ›´æ–°é †
	                break;
	            default:
	                sort = Sort.by(Sort.Order.desc("createdAt"));  // æ–°ç€é †ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
	                break;
	        }

	        pageable = PageRequest.of(pageable.getPageNumber(), pageable.getPageSize(), sort);
	        
//		  Page<Datas> datasPage = datasRepository.findAll(pageable);
		  Page<Datas> datasPage;
		  
		  System.out.println("ãƒ†ã‚¹ãƒˆ2");
		 
//		  model.addAttribute("datasPage", datasPage);
		  
		  System.out.println("ãƒ†ã‚¹ãƒˆ3");
		  if (keyword != null && !keyword.isEmpty()) {
//	            datasPage = datasRepository.findByNameLike("%" + keyword + "%", pageable);
			  datasPage = datasRepository.findByCollectionIdAndNameContaining(id, keyword, pageable);
	        } else {
//	            datasPage = datasRepository.findAll(pageable);
	        	datasPage = datasRepository.findByCollectionId(id, pageable);
	        }  
		  
		  Collection collection = collectionRepository.getReferenceById(id);
		  if (categoryId != null) {
		        datasPage = datasRepository.findByCollectionIdAndCategoryIdAndNameContaining(collection.getId(), categoryId, keyword != null ? keyword : "", pageable);
		    } else {
		        datasPage = datasRepository.findByCollectionIdAndNameContaining(collection.getId(), keyword != null ? keyword : "", pageable);
		    }

//		    List<Category> categories = categoryRepository.findAll();
		  Integer genreId = collection.getGenre().getId();

		    // ãã®ã‚¸ãƒ£ãƒ³ãƒ«ã«å±ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å–å¾—
		  List<Category> categories = categoryRepository.findByGenreId(genreId);

		    
		  model.addAttribute("datasPage", datasPage);
		  model.addAttribute("keyword", keyword);
		  model.addAttribute("categories", categories);
		  model.addAttribute("order", order);
		  model.addAttribute("collection", collection); 
		  model.addAttribute("selectedCategory", categoryId);
//		  System.out.println(datasPage);
	        return "data/show";
	    }   
	  
//	  @PostMapping("/create")
//	    public Datas createData(
//	            @RequestParam String dataName,
//	            @RequestParam Integer collectionId,
//	            @RequestParam Integer categoryId,
//	            @RequestParam Integer price
//	    ) {
//	        return datasService.createData(dataName, collectionId, categoryId, price);
//	    }
	  
	  @GetMapping("/register")
	    public String showForm(@RequestParam(name = "collectionId") Integer collectionId, Model model) {
		  System.out.println("ãƒ†ã‚¹ãƒˆ");
	        // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³IDã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
	        Collection collection = collectionRepository.findById(collectionId)
	                .orElseThrow(() -> new IllegalArgumentException("Invalid Collection ID"));
	        System.out.println("ãƒ†ã‚¹ãƒˆ2");
	        // ã‚¸ãƒ£ãƒ³ãƒ«IDã‚’å–å¾—
	        Integer genreId = collection.getGenre().getId();

	        // ã‚¸ãƒ£ãƒ³ãƒ«IDã«åŸºã¥ãã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
	        List<Category> categories = categoryRepository.findByGenreId(genreId);
	        System.out.println("ãƒ†ã‚¹ãƒˆï¼“");
	        DatasForm datasForm = new DatasForm();
	        datasForm.setCollectionId(collectionId);
	        System.out.println("ãƒ†ã‚¹ãƒˆï¼”");
	        System.out.println(collectionId);
	        // ãƒ¢ãƒ‡ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
	        model.addAttribute("categories", categories);
	        model.addAttribute("collectionId", collectionId);
	        model.addAttribute("datasForm", datasForm);
	        return "data/register";
	    }

	  @PostMapping("/register")
	  public String register(@ModelAttribute DatasForm datasForm) {
	      // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®å€¤ã‚’ãƒã‚§ãƒƒã‚¯
	      if ("null".equals(datasForm.getPrice())) {
	          datasForm.setPrice(null); // æ–‡å­—åˆ—ã® "null" ã‚’æœ¬å½“ã® null ã«å¤‰æ›
	      }
	      
	      // ã‚µãƒ¼ãƒ“ã‚¹ã«ä¿å­˜
	      datasService.createData(datasForm);
	      
	      return "redirect:/data/" + datasForm.getCollectionId();
	  }
//	  @GetMapping("/register")
//	    public String register() {
//	        return "data/register";
//	    }  
	    
	    @GetMapping("/{id}/edit")
	    public String edit(@PathVariable(name = "id") int id, Model model) {
	        Datas datas = datasRepository.getReferenceById(id);

	        // âœ… ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¸ãƒ£ãƒ³ãƒ«IDã‚’å–å¾—
	        Integer genreId = datas.getCollection().getGenre().getId();

	        // âœ… ãã®ã‚¸ãƒ£ãƒ³ãƒ«IDã«ç´ã¥ãã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã‚’å–å¾—
	        List<Category> categories = categoryRepository.findByGenreId(genreId);

	        // âœ… `DatasEditForm` ã®ä½œæˆ
	        DatasEditForm datasEditForm = new DatasEditForm(
	            datas.getId(),
	            datas.getName(),
	            datas.getPrice(),
	            datas.getCollection(),
	            datas.getCategory().getId()
	        );

	        model.addAttribute("datasEditForm", datasEditForm);
	        model.addAttribute("collectionId", datas.getCollection().getId());
	        model.addAttribute("datas", datas);
	        model.addAttribute("categories", categories); // ğŸ”¥ ã“ã®ã‚¸ãƒ£ãƒ³ãƒ«ã«å¯¾å¿œã™ã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã‚’æ¸¡ã™

	        return "data/edit";
	    }
	        
	        @PostMapping("/{id}/update")
	        public String update(@ModelAttribute @Validated DatasEditForm datasEditForm, BindingResult bindingResult, RedirectAttributes redirectAttributes) {        
	            if (bindingResult.hasErrors()) {
	                return "data/edit";
	            }

	            Datas datas = datasRepository.getReferenceById(datasEditForm.getId());
	            datas.setName(datasEditForm.getName());
	            datas.setPrice(datasEditForm.getPrice());
	            datas.setCollection(datasEditForm.getCollectionId());
	            datas.setCategory(categoryRepository.getReferenceById(datasEditForm.getCategoryId())); // âœ… ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°

	            datasRepository.save(datas); // âœ… æ›´æ–°ã‚’ä¿å­˜

	            redirectAttributes.addFlashAttribute("successMessage", "æƒ…å ±ã‚’ç·¨é›†ã—ã¾ã—ãŸã€‚");
	            
	            return "redirect:/data/"+ datasEditForm.getCollectionId().getId();
	        } 
	    
	    @GetMapping("/random")
	    public ResponseEntity<?> getRandomData(@RequestParam("collectionId") Integer collectionId) {
	        Optional<Datas> randomData = datasRepository.findRandomDataByCollectionId(collectionId);

	        if (randomData.isPresent()) {
	            return ResponseEntity.ok(randomData.get());
	        } else {
	            return ResponseEntity.status(HttpStatus.NOT_FOUND).body("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
	        }
	    }
	    
	    
	    @GetMapping("/total-price")
	    public ResponseEntity<?> getTotalPrice(@RequestParam("collectionId") Integer collectionId) {
	        Integer totalPrice = datasRepository.getTotalPriceByCollectionId(collectionId);
	        if (totalPrice != null) {
	            return ResponseEntity.ok(totalPrice);
	        } else {
	            return ResponseEntity.ok(0); // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ 0 ã‚’è¿”ã™
	        }
	    }
	    
	    @GetMapping("/total-height")
	    public ResponseEntity<?> getTotalHeight(@RequestParam("collectionId") Integer collectionId) {
	        Integer count = datasRepository.countByCollectionId(collectionId);
	        if (count != null && count > 0) {
	            double totalHeight = (count * 15) / 10.0; // 15mm * å€‹æ•° â†’ cm ã«å¤‰æ›
	            return ResponseEntity.ok(totalHeight);
	        } else {
	            return ResponseEntity.ok(0.0); // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ 0.0cm ã‚’è¿”ã™
	        }
	    }
	    
	    @PostMapping("/{id}/delete")
	    public String delete(@PathVariable(name = "id") Integer id, RedirectAttributes redirectAttributes) {
		 System.out.println("ãƒ†ã‚¹ãƒˆãƒ‡ãƒªãƒ¼ãƒˆ");
		 Integer collectionId = datasRepository.getReferenceById(id).getCollection().getId();
	        datasRepository.deleteById(id);
	        System.out.println("ãƒ†ã‚¹ãƒˆ2");
//	        Collection collection = collectionRepository.getReferenceById(id);
	        redirectAttributes.addFlashAttribute("successMessage", "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
	        
	        return "redirect:/data/" + collectionId;
//	        return "index";
	    }    
	    
	  @GetMapping("/high")
	    public String high() {
	        return "data/high";
	    }  
	  
	  @GetMapping("/amount")
	    public String amount() {
	        return "data/amount";
	    }  
	  
	  
}
